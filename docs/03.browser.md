# 瀏覽器自動化功能 (Browser Automation)

PCAI 內建了一套瀏覽器自動化工具，允許 AI Agent 代表使用者與網頁進行互動。這套系統基於 Playwright 等技術，讓 Agent 能夠像真人一樣瀏覽網頁、分析畫面結構、點擊按鈕、填寫表單以及擷取資料。

## 核心運作流程 (Core Workflow)

瀏覽器自動化的核心概念是「快照與參考 (Snapshot & Reference)」。Agent 必須先對當前網頁畫面進行快照，取得畫面上所有可互動元素的「參考 ID (Reference ID，例如 `@e1`)」，然後才能透過這些 ID 來操作特定元素。

標準的互動流程如下：

1.  **導航 (Navigate)**：使用 `browser_open` 開啟目標網址。
2.  **快照 (Snapshot)**：使用 `browser_snapshot` 分析當前畫面，取得互動元素的參考 ID (如 `@e1`, `@e2`)。
3.  **互動 (Interact)**：使用取得的參考 ID 執行點擊 (`browser_click`) 或輸入文字 (`browser_type`)。
4.  **重新快照 (Re-snapshot)**：只要畫面發生變化（例如換頁、彈出視窗、展開選單），之前的參考 ID 就會失效。必須**再次執行 `browser_snapshot`** 以取得最新的畫面結構。

## 可用工具 (Available Tools)

這些工具定義在 `skills/browser/tools.go` 中，並透過動態技能系統註冊給 LLM 使用：

### 1. 導航 (Navigation)
*   **`browser_open`**
    *   **描述**：開啟瀏覽器並導航到指定網址。支援 `http://`, `https://`, 甚至本機 `file://`。
    *   **參數**：
        *   `url` (字串，必填)：要開啟的網址。

### 2. 畫面分析 (Page Analysis)
*   **`browser_snapshot`**
    *   **描述**：獲取畫面結構與互動元素 (ARIA Snapshot)。這是所有互動的基礎。
    *   **參數**：
        *   `interactive_only` (布林值，預設 `true`)：設為 `true` 時，只回傳按鈕、輸入框、連結等「可互動」的元素；設為 `false` 可以看到包含標題和段落的完整結構。
    *   **回傳範例**：`- role "button" "登入" [ref=@e1]`。後續操作請使用這個 `@e1`。

### 3. 元素互動 (Interaction)
*   **`browser_click`**
    *   **描述**：點擊畫面上指定的元素。
    *   **參數**：
        *   `ref` (字串，必填)：元素的參考 ID (必須以 `@e` 開頭，如 `@e1`)。
*   **`browser_type`**
    *   **描述**：在指定的輸入框元素中填寫文字。
    *   **參數**：
        *   `ref` (字串，必填)：元素的參考 ID。
        *   `text` (字串，必填)：要輸入的文字內容。
*   **`browser_scroll`**
    *   **描述**：捲動網頁，方便查看被遮擋的內容或觸發延遲載入 (Lazy load)。
    *   **參數**：
        *   `direction` (字串)：捲動方向，可選值為 `up`, `down` (預設), `top`, `bottom`。

### 4. 資料擷取 (Extraction)
*   **`browser_get`**
    *   **描述**：取得特定元素的文字內容或 HTML 結構，適合用來精準爬取網頁特定區塊的資料。
    *   **參數**：
        *   `ref` (字串，必填)：元素的參考 ID。
        *   `what` (字串)：要取得的內容類型，可選值為 `text` (預設) 或 `html`。

## 最佳實踐與限制

1.  **無頭模式 (Headless Mode)**：瀏覽器預設在無頭模式下背景執行，使用者不會看到實體的瀏覽器視窗彈出。
2.  **狀態短暫性**：元素的 Reference ID (`@e1`, `@e2`) 是**非常短暫的**。它們只在一次 `browser_snapshot` 後有效。只要呼叫了會改變 DOM 的動作（如 Click），之前的 ID 就不能保證還能對應到原本的元素。
3.  **等待載入**：在呼叫 `browser_open` 或觸發搜尋後，如果網頁載入較慢，Agent 可能需要適時重試 `browser_snapshot` 確保畫面已完全渲染。
4.  **複雜互動**：對於複雜的登入流程或需要拖曳的 UI，可能需要多次 Snapshot 與 Interact 組合。

## 內部實作細節

*   **實體管理**：瀏覽器的底層操作由 `internal/browser` 套件內的 `Manager` 負責封裝（本專案實作可能基於 chromedp 或 Playwright）。
*   **技能整合**：與 CLI 和 Telegram 等 Adapter 相同，瀏覽器工具被註冊在 `Registry` 中（參見 `tools/init.go`），只要確保執行環境支援 Chrome/Chromium 即可自動啟動相關引擎。
